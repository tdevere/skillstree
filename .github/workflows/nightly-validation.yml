name: Nightly Validation
on:
  schedule:
    - cron: '0 6 * * *'   # 06:00 UTC daily
  workflow_dispatch:

jobs:
  nightly:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install deps
        run: python -m pip install --upgrade pip && pip install -r requirements.txt
      - name: Run validation script and write JSON
        run: |
          python run_validation.py --nodes-file nightly_nodes.txt --output nightly_result.json || true
      - name: Create issues for failing checks
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = 'nightly_result.json';
            if (!fs.existsSync(path)) { core.warning('no result file'); return; }
            const res = JSON.parse(fs.readFileSync(path, 'utf8'));
            const failures = res.failures || [];
            for (const r of failures) {
              const title = `Validation failed: ${r.node} rank ${r.rank} - ${r.check}`;
              const body = `Automated nightly validation failed.\n\n**Node**: ${r.node}\n**Rank**: ${r.rank}\n**Command**: ${r.command}\n**Exit**: ${r.exit_code}\n\nOutput:\n\`\`\`\n${r.output}\n\`\`\`\n\nPlease investigate or mark as manual_check.`;
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['automated-failure','needs-triage']
              });
            }
